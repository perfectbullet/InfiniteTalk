# docker-compose.yml
name: Infinitetalk

services:

  infinitetalk:
    image: infinitetalk:v5
    container_name: infinitetalk_v5
    ports:
      - "50002:50002"
      - "50003:50003"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]
    environment:
      - TZ=Asia/Shanghai
      - LANG=C.UTF-8
      - PYTHONUNBUFFERED=1
      - CUDA_LAUNCH_BLOCKING=0
      # MongoDB 连接配置
      - MONGO_URL=mongodb://admin:infinitetalk123@mongodb:27017/infinitetalk_db?authSource=admin
      - MONGO_DB_NAME=infinitetalk_db
    volumes:
      # 时区同步
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /home/user/metahuman_work/InfiniteTalk:/workspace/InfiniteTalk
      # Hugging Face 缓存（可选）
      - ~/.cache/huggingface:/root/.cache/huggingface
    working_dir: /workspace/InfiniteTalk
    # 启动命令
    command: tail -f /dev/null
    restart: unless-stopped
    # 共享内存（重要！）
    shm_size: '32gb'
    # 网络
    networks:
      - infinitetalk-net
    # 依赖 MongoDB 服务
    depends_on:
      mongodb:
        condition: service_healthy
    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import torch; print(torch.cuda.is_available())"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mongodb:
    image: mongo:7.0
    container_name: infinitetalk_mongodb
    environment:
      - TZ=Asia/Shanghai
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=infinitetalk123
      - MONGO_INITDB_DATABASE=infinitetalk_db
    volumes:
      # 使用命名数据卷存储 MongoDB 数据
      - infinitetalk_mongodb_data:/data/db
      # 使用命名数据卷存储 MongoDB 配置
      - infinitetalk_mongodb_config:/data/configdb
      # 初始化脚本（使用绑定挂载）
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - infinitetalk-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

volumes:
  infinitetalk_mongodb_data:
    driver: local
  infinitetalk_mongodb_config:
    driver: local

networks:
  infinitetalk-net:
    driver: bridge